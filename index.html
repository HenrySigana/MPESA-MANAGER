
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M-Pesa Shop Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700;900&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f0faf5;
  --surface: #ffffff;
  --card: #ffffff;
  --green: #00a550;
  --green-dark: #007a3a;
  --green-light: #e6f7ef;
  --green2: #43e097;
  --red: #e53e3e;
  --red-light: #fff5f5;
  --amber: #d97706;
  --amber-light: #fffbeb;
  --text: #1a2e22;
  --muted: #6b7280;
  --border: #d1fae5;
  --shadow: 0 4px 24px rgba(0,165,80,0.10);
  --radius: 16px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: 'Nunito', sans-serif; min-height: 100vh; }

/* HEADER */
header {
  background: linear-gradient(135deg, #00a550 0%, #007a3a 60%, #005a2a 100%);
  padding: 20px 28px 18px;
  position: sticky; top: 0; z-index: 100;
  box-shadow: 0 4px 20px rgba(0,100,50,0.25);
}
.header-inner { display: flex; align-items: center; justify-content: space-between; max-width: 1000px; margin: 0 auto; }
.brand { display: flex; align-items: center; gap: 14px; }
.brand-logo {
  width: 50px; height: 50px;
  background: rgba(255,255,255,0.2);
  border: 2px solid rgba(255,255,255,0.4);
  border-radius: 14px;
  display: grid; place-items: center; font-size: 24px;
}
.brand h1 { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; color: #fff; letter-spacing: 1px; }
.brand p { font-size: 0.72rem; color: rgba(255,255,255,0.75); letter-spacing: 2px; text-transform: uppercase; margin-top: 2px; }
.header-time { text-align: right; }
.header-time .hdate { font-family: 'Orbitron', sans-serif; font-size: 0.85rem; color: #fff; }
.header-time .htime { font-size: 0.72rem; color: rgba(255,255,255,0.7); margin-top: 2px; }

/* NAV */
nav {
  background: var(--surface); border-bottom: 2px solid var(--border);
  padding: 10px 28px; display: flex; gap: 6px; overflow-x: auto;
  max-width: 100%;
}
nav button {
  background: none; border: none; color: var(--muted);
  padding: 8px 20px; border-radius: 30px; cursor: pointer;
  font-family: 'Nunito', sans-serif; font-size: 0.9rem; font-weight: 700;
  white-space: nowrap; transition: all 0.2s;
}
nav button:hover { background: var(--green-light); color: var(--green); }
nav button.active { background: var(--green); color: #fff; }

/* MAIN */
main { max-width: 1000px; margin: 0 auto; padding: 24px 20px; }
.tab { display: none; }
.tab.active { display: block; }

/* SECTION TITLE */
.stitle {
  font-family: 'Orbitron', sans-serif; font-size: 0.9rem; color: var(--green-dark);
  letter-spacing: 1px; margin-bottom: 18px;
  display: flex; align-items: center; gap: 10px;
}
.stitle::after { content: ''; flex: 1; height: 2px; background: var(--border); }

/* STATS GRID */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 28px; }
.stat {
  background: var(--card); border-radius: var(--radius); padding: 20px 18px;
  box-shadow: var(--shadow); border: 1px solid var(--border);
  position: relative; overflow: hidden;
}
.stat::after {
  content: ''; position: absolute; bottom: -20px; right: -20px;
  width: 80px; height: 80px; border-radius: 50%;
  background: var(--green-light); opacity: 0.6;
}
.stat.red { border-top: 3px solid var(--red); }
.stat.green { border-top: 3px solid var(--green); }
.stat.amber { border-top: 3px solid var(--amber); }
.stat.blue { border-top: 3px solid #3b82f6; }
.stat-label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); margin-bottom: 8px; }
.stat-val { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 700; color: var(--text); }
.stat-val.pos { color: var(--green); }
.stat-val.neg { color: var(--red); }
.stat-sub { font-size: 0.75rem; color: var(--muted); margin-top: 4px; }

/* DAY SETUP FORM */
.setup-card {
  background: var(--card); border-radius: var(--radius); padding: 24px;
  box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 24px;
}
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 18px; }
.fg { display: flex; flex-direction: column; gap: 6px; }
label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); }
input, select {
  background: var(--bg); border: 1.5px solid var(--border); border-radius: 10px;
  color: var(--text); padding: 11px 14px; font-family: 'Nunito', sans-serif;
  font-size: 0.95rem; font-weight: 600; outline: none; transition: border 0.2s;
}
input:focus, select:focus { border-color: var(--green); background: #fff; }
input[readonly] { background: #f9f9f9; color: var(--muted); cursor: not-allowed; }

/* BUTTONS */
.btn {
  padding: 11px 26px; border-radius: 10px; border: none; cursor: pointer;
  font-family: 'Nunito', sans-serif; font-size: 0.95rem; font-weight: 700;
  transition: all 0.2s; letter-spacing: 0.3px;
}
.btn-green { background: var(--green); color: #fff; }
.btn-green:hover { background: var(--green-dark); transform: translateY(-1px); }
.btn-outline { background: none; border: 2px solid var(--green); color: var(--green); }
.btn-outline:hover { background: var(--green-light); }
.btn-red { background: var(--red); color: #fff; }
.btn-red:hover { background: #c53030; }
.btn-amber { background: var(--amber); color: #fff; }
.btn-sm { padding: 6px 14px; font-size: 0.82rem; }
.btn-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

/* TRANSACTION TABLE */
.table-wrap { overflow-x: auto; border-radius: var(--radius); border: 1.5px solid var(--border); box-shadow: var(--shadow); background: #fff; }
table { width: 100%; border-collapse: collapse; }
thead { background: linear-gradient(90deg, var(--green), var(--green-dark)); }
th { padding: 13px 16px; text-align: left; font-size: 0.78rem; letter-spacing: 1px; color: #fff; text-transform: uppercase; font-weight: 700; }
td { padding: 12px 16px; border-top: 1px solid var(--border); font-size: 0.88rem; font-weight: 600; }
tr:hover td { background: var(--green-light); }
.type-dep { color: var(--green); font-weight: 700; }
.type-wit { color: var(--red); font-weight: 700; }
.type-buy { color: #3b82f6; font-weight: 700; }
.type-sell { color: var(--amber); font-weight: 700; }
.badge { display: inline-block; padding: 3px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
.badge-dep { background: var(--green-light); color: var(--green); }
.badge-wit { background: var(--red-light); color: var(--red); }
.badge-buy { background: #eff6ff; color: #3b82f6; }
.badge-sell { background: var(--amber-light); color: var(--amber); }

/* TXN FORM */
.txn-form { background: var(--card); border-radius: var(--radius); padding: 22px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 22px; }

/* SUMMARY CARD */
.summary-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
.summary-box { background: var(--card); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); }
.summary-box h3 { font-family: 'Orbitron', sans-serif; font-size: 0.8rem; color: var(--green-dark); margin-bottom: 14px; }
.sum-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--border); font-size: 0.88rem; }
.sum-row:last-child { border: none; font-weight: 700; font-size: 1rem; }
.sum-row span:last-child { font-family: 'Orbitron', sans-serif; font-size: 0.95rem; }
.profit { color: var(--green); }
.loss { color: var(--red); }

/* CLOSE DAY PANEL */
.close-panel { background: linear-gradient(135deg, #fff9e6, #fff); border: 2px solid var(--amber); border-radius: var(--radius); padding: 22px; margin-bottom: 22px; }
.close-panel h3 { font-family: 'Orbitron', sans-serif; font-size: 0.85rem; color: var(--amber); margin-bottom: 16px; }

/* HISTORY */
.history-day { background: var(--card); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 16px; }
.history-day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; cursor: pointer; }
.history-day-header h3 { font-family: 'Orbitron', sans-serif; font-size: 0.85rem; color: var(--green-dark); }
.day-stats { display: flex; gap: 16px; flex-wrap: wrap; }
.day-stat { font-size: 0.82rem; color: var(--muted); }
.day-stat strong { color: var(--text); }

/* ALERT */
.alert { border-radius: 10px; padding: 12px 16px; font-size: 0.88rem; font-weight: 600; margin-bottom: 16px; }
.alert-green { background: var(--green-light); color: var(--green-dark); border: 1px solid var(--green); }
.alert-amber { background: var(--amber-light); color: var(--amber); border: 1px solid var(--amber); }
.alert-red { background: var(--red-light); color: var(--red); border: 1px solid var(--red); }

/* EMPTY */
.empty { text-align: center; padding: 40px; color: var(--muted); }
.empty-icon { font-size: 3rem; opacity: 0.35; margin-bottom: 10px; }

/* TOAST */
#toast { position: fixed; bottom: 24px; right: 20px; background: var(--green); color: #fff; padding: 13px 24px; border-radius: 12px; font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 0.95rem; opacity: 0; transform: translateY(16px); transition: all 0.3s; pointer-events: none; z-index: 9999; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
#toast.show { opacity: 1; transform: translateY(0); }

/* DAY STATUS */
.day-status { display: inline-flex; align-items: center; gap: 6px; padding: 5px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; margin-bottom: 18px; }
.day-open { background: var(--green-light); color: var(--green); }
.day-closed { background: var(--red-light); color: var(--red); }
.dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }

@media(max-width:600px){
  main { padding: 14px 12px; }
  nav { padding: 8px 12px; }
  header { padding: 14px 16px; }
  .summary-row { grid-template-columns: 1fr; }
  .brand h1 { font-size: 0.95rem; }
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="brand-logo">üì±</div>
      <div>
        <h1>M-PESA MANAGER</h1>
        <p>Daily Float &amp; Cash Tracker</p>
      </div>
    </div>
    <div class="header-time">
      <div class="hdate" id="hDate"></div>
      <div class="htime" id="hTime"></div>
    </div>
  </div>
</header>

<nav>
  <button class="active" onclick="switchTab('today',this)">üìä Today</button>
  <button onclick="switchTab('transactions',this)">üí∏ Transactions</button>
  <button onclick="switchTab('summary',this)">üìã Summary</button>
  <button onclick="switchTab('history',this)">üìÖ History</button>
</nav>

<main>

<!-- TODAY TAB -->
<div class="tab active" id="tab-today">

  <div id="no-day-panel">
    <div class="alert alert-amber">‚ö†Ô∏è No active session. Please open today's business day below.</div>
    <div class="setup-card">
      <div class="stitle">üåÖ Open Business Day</div>
      <div class="form-grid">
        <div class="fg">
          <label>Date</label>
          <input type="date" id="open-date">
        </div>
        <div class="fg">
          <label>Opening Float (Cash in Till) KSh</label>
          <input type="number" id="open-float" placeholder="e.g. 5000" min="0">
        </div>
        <div class="fg">
          <label>Opening M-Pesa E-Float KSh</label>
          <input type="number" id="open-mpesa" placeholder="e.g. 10000" min="0">
        </div>
      </div>
      <button class="btn btn-green" onclick="openDay()">üåÖ Open Day</button>
    </div>
  </div>

  <div id="day-panel" style="display:none">
    <div id="day-status-badge"></div>
    <div class="stats-grid" id="live-stats"></div>

    <div id="close-day-section" style="display:none">
      <div class="close-panel">
        <h3>üåá CLOSE BUSINESS DAY</h3>
        <div class="form-grid">
          <div class="fg">
            <label>Closing Float (Cash in Till) KSh</label>
            <input type="number" id="close-float" placeholder="Count your cash..." min="0">
          </div>
          <div class="fg">
            <label>Closing M-Pesa E-Float KSh</label>
            <input type="number" id="close-mpesa" placeholder="Check M-Pesa balance..." min="0">
          </div>
        </div>
        <div class="btn-row">
          <button class="btn btn-amber" onclick="closeDay()">üåá Close &amp; Save Day</button>
          <button class="btn btn-outline btn-sm" onclick="toggleCloseSection()">Cancel</button>
        </div>
      </div>
    </div>

    <div id="open-actions" class="btn-row" style="margin-bottom:20px">
      <button class="btn btn-outline" onclick="switchTab('transactions', document.querySelectorAll(\'nav button\')[1])">‚ûï Add Transaction</button>
      <button class="btn btn-red btn-sm" onclick="toggleCloseSection()">üåá Close Day</button>
    </div>

    <div class="stitle">Today's Transactions</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Time</th><th>Type</th><th>Amount (KSh)</th><th>Charge (KSh)</th><th>Note</th><th></th></tr></thead>
        <tbody id="today-txn-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- TRANSACTIONS TAB -->
<div class="tab" id="tab-transactions">
  <div id="txn-no-day" class="alert alert-amber" style="display:none">‚ö†Ô∏è Please open a business day first (go to Today tab).</div>
  <div id="txn-form-wrap">
    <div class="txn-form">
      <div class="stitle">‚ûï Record Transaction</div>
      <div class="form-grid">
        <div class="fg">
          <label>Transaction Type</label>
          <select id="txn-type" onchange="updateTxnFields()">
            <option value="deposit">üì• Customer Deposit (Send Money)</option>
            <option value="withdraw">üì§ Customer Withdrawal</option>
            <option value="buy_float">üîÑ Buy E-Float (Top Up M-Pesa)</option>
            <option value="sell_float">üíµ Sell Float (Convert E-Float to Cash)</option>
            <option value="till_deposit">üè¶ Till Deposit (Bank to M-Pesa)</option>
            <option value="till_withdraw">üèß Till Withdrawal (M-Pesa to Bank)</option>
          </select>
        </div>
        <div class="fg">
          <label>Amount (KSh)</label>
          <input type="number" id="txn-amount" placeholder="Transaction amount" min="0" oninput="calcCharge()">
        </div>
        <div class="fg" id="charge-group">
          <label>M-Pesa Charge (KSh) <span style="color:var(--green);font-size:0.7rem">auto-calculated</span></label>
          <input type="number" id="txn-charge" placeholder="0" min="0">
        </div>
        <div class="fg">
          <label>Note (optional)</label>
          <input type="text" id="txn-note" placeholder="e.g. customer name, ref...">
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-green" onclick="addTransaction()">‚úÖ Record Transaction</button>
        <button class="btn btn-outline" onclick="clearTxnForm()">Clear</button>
      </div>
    </div>

    <div class="stitle">Today's Transactions</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Time</th><th>Type</th><th>Amount (KSh)</th><th>Charge (KSh)</th><th>Float Effect</th><th>Note</th><th></th></tr></thead>
        <tbody id="txn-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- SUMMARY TAB -->
<div class="tab" id="tab-summary">
  <div id="summary-content"></div>
</div>

<!-- HISTORY TAB -->
<div class="tab" id="tab-history">
  <div class="stitle">üìÖ Past Business Days</div>
  <div id="history-list"></div>
</div>

</main>
<div id="toast"></div>

<script>
// ===================== DATA =====================
let data = JSON.parse(localStorage.getItem('mpesa_data') || '{"days":[],"activeDay":null}');
function save(){ localStorage.setItem('mpesa_data', JSON.stringify(data)); }

// ===================== CLOCK =====================
function pad(n){ return String(n).padStart(2,'0'); }
function tick(){
  let n=new Date();
  document.getElementById('hDate').textContent=n.toLocaleDateString('en-KE',{weekday:'short',day:'numeric',month:'long',year:'numeric'});
  document.getElementById('hTime').textContent=n.toLocaleTimeString('en-KE');
}
setInterval(tick,1000); tick();

// Pre-fill today's date
document.getElementById('open-date').value = new Date().toISOString().split('T')[0];

// ===================== TOAST =====================
function toast(msg, type='green'){
  let t=document.getElementById('toast');
  t.textContent=msg;
  t.style.background = type==='red'?'#e53e3e':type==='amber'?'#d97706':'#00a550';
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2800);
}

// ===================== TABS =====================
function switchTab(t, btn){
  document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(e=>e.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
  if(btn) btn.classList.add('active');
  else document.querySelectorAll('nav button')[['today','transactions','summary','history'].indexOf(t)].classList.add('active');
  if(t==='today') renderToday();
  if(t==='transactions') renderTxnTab();
  if(t==='summary') renderSummary();
  if(t==='history') renderHistory();
}

// ===================== M-PESA TARIFF =====================
// Withdrawal charges (approximate Safaricom tariff bands)
const WITHDRAW_CHARGES = [
  [1,49,0],[50,100,11],[101,500,29],[501,1000,29],[1001,1500,29],
  [1501,2500,29],[2501,3500,52],[3501,5000,69],[5001,7500,87],
  [7501,10000,115],[10001,15000,167],[15001,20000,185],
  [20001,25000,197],[25001,30000,208],[30001,35000,220],
  [35001,40000,233],[40001,45000,245],[45001,50000,258],
  [50001,70000,290],[70001,100000,350],[100001,150000,513]
];
function getWithdrawCharge(amt){
  for(let [lo,hi,fee] of WITHDRAW_CHARGES){ if(amt>=lo&&amt<=hi) return fee; }
  return 0;
}
function calcCharge(){
  let type=document.getElementById('txn-type').value;
  let amt=parseFloat(document.getElementById('txn-amount').value)||0;
  if(type==='withdraw'){ document.getElementById('txn-charge').value=getWithdrawCharge(amt); }
  else if(type==='deposit'){ document.getElementById('txn-charge').value=0; }
}
function updateTxnFields(){
  calcCharge();
  let type=document.getElementById('txn-type').value;
  let cg=document.getElementById('charge-group');
  cg.style.display=(type==='buy_float'||type==='sell_float'||type==='till_deposit'||type==='till_withdraw')?'none':'';
}

// ===================== OPEN / CLOSE DAY =====================
function openDay(){
  let date=document.getElementById('open-date').value;
  let openFloat=parseFloat(document.getElementById('open-float').value)||0;
  let openMpesa=parseFloat(document.getElementById('open-mpesa').value)||0;
  if(!date){ toast('Select a date','amber'); return; }
  if(data.days.find(d=>d.date===date&&d.closed)){ toast('A closed day already exists for this date','amber'); return; }

  data.activeDay = {
    id: Date.now(),
    date, openFloat, openMpesa,
    closeFloat: null, closeMpesa: null,
    closed: false,
    transactions: []
  };
  data.days.push(data.activeDay);
  save();
  toast('üåÖ Business day opened!');
  renderToday();
}

function toggleCloseSection(){
  let s=document.getElementById('close-day-section');
  s.style.display=s.style.display==='none'?'block':'none';
}

function closeDay(){
  let cf=parseFloat(document.getElementById('close-float').value);
  let cm=parseFloat(document.getElementById('close-mpesa').value);
  if(isNaN(cf)||isNaN(cm)){ toast('Enter closing float and M-Pesa balance','amber'); return; }
  let day=getActiveDay();
  if(!day){ toast('No active day','red'); return; }
  day.closeFloat=cf; day.closeMpesa=cm; day.closed=true;
  data.activeDay=null;
  save(); toast('üåá Day closed successfully!'); renderToday();
}

function getActiveDay(){
  if(!data.activeDay) return null;
  return data.days.find(d=>d.id===data.activeDay.id);
}

// ===================== TRANSACTIONS =====================
function addTransaction(){
  let day=getActiveDay();
  if(!day){ toast('Open a business day first!','amber'); return; }
  let type=document.getElementById('txn-type').value;
  let amount=parseFloat(document.getElementById('txn-amount').value)||0;
  let charge=parseFloat(document.getElementById('txn-charge').value)||0;
  let note=document.getElementById('txn-note').value;
  if(!amount){ toast('Enter transaction amount','amber'); return; }

  let now=new Date(), time=`${pad(now.getHours())}:${pad(now.getMinutes())}`;
  day.transactions.push({ id:Date.now(), time, type, amount, charge, note });
  save(); clearTxnForm(); toast('‚úÖ Transaction recorded!');
  renderTxnTab(); renderToday();
}

function deleteTxn(id){
  let day=getActiveDay();
  if(!day){ toast('Cannot delete from closed day','red'); return; }
  if(!confirm('Delete this transaction?')) return;
  day.transactions=day.transactions.filter(t=>t.id!==id);
  save(); renderTxnTab(); renderToday(); toast('üóë Deleted','amber');
}

function clearTxnForm(){
  document.getElementById('txn-amount').value='';
  document.getElementById('txn-charge').value='';
  document.getElementById('txn-note').value='';
}

// ===================== FLOAT CALCULATIONS =====================
function calcDayStats(day){
  let floatCash = day.openFloat;
  let eMpesa = day.openMpesa;
  let totalDeposits=0, totalWithdrawals=0, totalCharges=0, totalBuyFloat=0, totalSellFloat=0;

  day.transactions.forEach(t=>{
    if(t.type==='deposit'){
      // customer deposits cash ‚Üí we give e-float ‚Üí cash goes up, e-float goes down
      floatCash += t.amount;
      eMpesa -= t.amount;
      totalDeposits += t.amount;
    } else if(t.type==='withdraw'){
      // customer wants cash ‚Üí we give cash, receive e-float + charge
      floatCash -= t.amount;
      eMpesa += t.amount;
      floatCash += t.charge; // charge paid in cash
      totalWithdrawals += t.amount;
      totalCharges += t.charge;
    } else if(t.type==='buy_float'){
      // we buy e-float: cash goes out, e-float goes up
      floatCash -= t.amount;
      eMpesa += t.amount;
      totalBuyFloat += t.amount;
    } else if(t.type==='sell_float'){
      // we sell e-float: cash comes in, e-float goes down
      floatCash += t.amount;
      eMpesa -= t.amount;
      totalSellFloat += t.amount;
    } else if(t.type==='till_deposit'){
      eMpesa += t.amount;
    } else if(t.type==='till_withdraw'){
      eMpesa -= t.amount;
    }
  });

  let totalFloat = floatCash + eMpesa;
  let expectedTotal = day.openFloat + day.openMpesa + totalCharges;
  return { floatCash, eMpesa, totalFloat, totalDeposits, totalWithdrawals, totalCharges, totalBuyFloat, totalSellFloat, expectedTotal };
}

function typeLabel(type){
  const map = {
    deposit:'üì• Deposit', withdraw:'üì§ Withdrawal', buy_float:'üîÑ Buy E-Float',
    sell_float:'üíµ Sell Float', till_deposit:'üè¶ Till Deposit', till_withdraw:'üèß Till Withdrawal'
  };
  return map[type]||type;
}
function typeBadgeClass(type){
  if(type==='deposit') return 'badge-dep';
  if(type==='withdraw') return 'badge-wit';
  if(type==='buy_float'||type==='till_deposit') return 'badge-buy';
  return 'badge-sell';
}
function floatEffect(type, amt){
  if(type==='deposit') return `<span style="color:var(--green)">Cash +${amt.toLocaleString()} | E-Float -${amt.toLocaleString()}</span>`;
  if(type==='withdraw') return `<span style="color:var(--red)">Cash -${amt.toLocaleString()} | E-Float +${amt.toLocaleString()}</span>`;
  if(type==='buy_float') return `<span style="color:#3b82f6">Cash -${amt.toLocaleString()} | E-Float +${amt.toLocaleString()}</span>`;
  if(type==='sell_float') return `<span style="color:var(--amber)">Cash +${amt.toLocaleString()} | E-Float -${amt.toLocaleString()}</span>`;
  if(type==='till_deposit') return `<span style="color:#3b82f6">E-Float +${amt.toLocaleString()}</span>`;
  if(type==='till_withdraw') return `<span style="color:var(--red)">E-Float -${amt.toLocaleString()}</span>`;
  return '‚Äî';
}

function txnRows(transactions, showDelete=false){
  if(!transactions.length) return `<tr><td colspan="7"><div class="empty"><div class="empty-icon">üì≠</div>No transactions recorded</div></td></tr>`;
  return [...transactions].reverse().map(t=>`
    <tr>
      <td>${t.time}</td>
      <td><span class="badge ${typeBadgeClass(t.type)}">${typeLabel(t.type)}</span></td>
      <td style="font-weight:700">KSh ${t.amount.toLocaleString()}</td>
      <td>${t.charge?`KSh ${t.charge.toLocaleString()}`:'‚Äî'}</td>
      <td>${floatEffect(t.type,t.amount)}</td>
      <td style="color:var(--muted)">${t.note||'‚Äî'}</td>
      <td>${showDelete?`<button class="btn btn-red btn-sm" onclick="deleteTxn('${t.id}')">üóë</button>`:'‚Äî'}</td>
    </tr>`).join('');
}

// ===================== RENDER TODAY =====================
function renderToday(){
  let day=getActiveDay();
  let noDayPanel=document.getElementById('no-day-panel');
  let dayPanel=document.getElementById('day-panel');

  // Check if there's a closed day for today
  let todayStr=new Date().toISOString().split('T')[0];
  let closedToday=data.days.find(d=>d.date===todayStr&&d.closed);

  if(!day){
    noDayPanel.style.display='block'; dayPanel.style.display='none';
    if(closedToday){
      noDayPanel.innerHTML=`<div class="alert alert-green">‚úÖ Today's business day has been closed. <button class="btn btn-outline btn-sm" onclick="showNewDayForm()">Open New Day</button></div>`;
    }
    return;
  }
  noDayPanel.style.display='none'; dayPanel.style.display='block';

  // Status badge
  document.getElementById('day-status-badge').innerHTML=
    `<div class="day-status ${day.closed?'day-closed':'day-open'}"><div class="dot"></div>${day.closed?'Day Closed':'Day Open'} ‚Äî ${day.date}</div>`;

  let s=calcDayStats(day);

  // Stats
  document.getElementById('live-stats').innerHTML=`
    <div class="stat green">
      <div class="stat-label">Cash Float (Till)</div>
      <div class="stat-val pos">KSh ${s.floatCash.toLocaleString()}</div>
      <div class="stat-sub">Opened: KSh ${day.openFloat.toLocaleString()}</div>
    </div>
    <div class="stat blue">
      <div class="stat-label">M-Pesa E-Float</div>
      <div class="stat-val" style="color:#3b82f6">KSh ${s.eMpesa.toLocaleString()}</div>
      <div class="stat-sub">Opened: KSh ${day.openMpesa.toLocaleString()}</div>
    </div>
    <div class="stat amber">
      <div class="stat-label">Today's Charges Earned</div>
      <div class="stat-val pos">KSh ${s.totalCharges.toLocaleString()}</div>
      <div class="stat-sub">${day.transactions.filter(t=>t.type==='withdraw').length} withdrawals</div>
    </div>
    <div class="stat">
      <div class="stat-label">Total Float Value</div>
      <div class="stat-val">KSh ${s.totalFloat.toLocaleString()}</div>
      <div class="stat-sub">Cash + E-Float combined</div>
    </div>`;

  // Close section
  document.getElementById('close-day-section').style.display='none';
  document.getElementById('open-actions').style.display=day.closed?'none':'flex';

  // Transactions
  document.getElementById('today-txn-tbody').innerHTML=txnRows(day.transactions, !day.closed);
}

function showNewDayForm(){
  document.getElementById('no-day-panel').innerHTML=`
    <div class="setup-card">
      <div class="stitle">üåÖ Open Business Day</div>
      <div class="form-grid">
        <div class="fg"><label>Date</label><input type="date" id="open-date" value="${new Date().toISOString().split('T')[0]}"></div>
        <div class="fg"><label>Opening Float (Cash in Till) KSh</label><input type="number" id="open-float" placeholder="e.g. 5000" min="0"></div>
        <div class="fg"><label>Opening M-Pesa E-Float KSh</label><input type="number" id="open-mpesa" placeholder="e.g. 10000" min="0"></div>
      </div>
      <button class="btn btn-green" onclick="openDay()">üåÖ Open Day</button>
    </div>`;
}

// ===================== RENDER TXN TAB =====================
function renderTxnTab(){
  let day=getActiveDay();
  let warn=document.getElementById('txn-no-day');
  let wrap=document.getElementById('txn-form-wrap');
  if(!day){ warn.style.display='block'; wrap.style.opacity='0.5'; wrap.style.pointerEvents='none'; }
  else { warn.style.display='none'; wrap.style.opacity='1'; wrap.style.pointerEvents='auto'; }

  let transactions=(day||{transactions:[]}).transactions;
  document.getElementById('txn-tbody').innerHTML=
    `${txnRows(transactions, !!day&&!day.closed).replace(/colspan="7"/g, 'colspan="7"')}`;
}

// ===================== RENDER SUMMARY =====================
function renderSummary(){
  let day=getActiveDay();
  if(!day){
    // Show last closed day
    let closed=[...data.days].filter(d=>d.closed).sort((a,b)=>b.date.localeCompare(a.date));
    day = closed[0];
  }
  if(!day){ document.getElementById('summary-content').innerHTML='<div class="empty"><div class="empty-icon">üìã</div>No day data yet. Open and record a business day first.</div>'; return; }
  
  let s=calcDayStats(day);
  let closedInfo = day.closed ? `
    <div class="sum-row"><span>Closing Float (Actual)</span><span>KSh ${(day.closeFloat||0).toLocaleString()}</span></div>
    <div class="sum-row"><span>Closing M-Pesa (Actual)</span><span>KSh ${(day.closeMpesa||0).toLocaleString()}</span></div>
    <div class="sum-row"><span>Float Variance</span><span class="${(day.closeFloat+day.closeMpesa)>=s.expectedTotal?'profit':'loss'}">${((day.closeFloat+day.closeMpesa)-s.expectedTotal)>=0?'+':''}KSh ${((day.closeFloat||0)+(day.closeMpesa||0)-s.expectedTotal).toLocaleString()}</span></div>
  ` : '';

  document.getElementById('summary-content').innerHTML=`
    <div class="day-status ${day.closed?'day-closed':'day-open'}"><div class="dot"></div>${day.closed?'Closed':'Open'} ‚Äî ${day.date}</div>
    <div class="summary-row">
      <div class="summary-box">
        <h3>üí∞ FLOAT POSITION</h3>
        <div class="sum-row"><span>Opening Cash Float</span><span>KSh ${day.openFloat.toLocaleString()}</span></div>
        <div class="sum-row"><span>Opening E-Float</span><span>KSh ${day.openMpesa.toLocaleString()}</span></div>
        <div class="sum-row"><span>Current Cash Float</span><span class="profit">KSh ${s.floatCash.toLocaleString()}</span></div>
        <div class="sum-row"><span>Current E-Float</span><span style="color:#3b82f6">KSh ${s.eMpesa.toLocaleString()}</span></div>
        <div class="sum-row"><span>Total Float Value</span><span>KSh ${s.totalFloat.toLocaleString()}</span></div>
        ${closedInfo}
      </div>
      <div class="summary-box">
        <h3>üìä TRANSACTIONS</h3>
        <div class="sum-row"><span>Total Deposits</span><span>KSh ${s.totalDeposits.toLocaleString()}</span></div>
        <div class="sum-row"><span>Total Withdrawals</span><span>KSh ${s.totalWithdrawals.toLocaleString()}</span></div>
        <div class="sum-row"><span>Buy Float (Top-ups)</span><span>KSh ${s.totalBuyFloat.toLocaleString()}</span></div>
        <div class="sum-row"><span>Sell Float</span><span>KSh ${s.totalSellFloat.toLocaleString()}</span></div>
        <div class="sum-row"><span>Withdrawal Charges Earned</span><span class="profit">KSh ${s.totalCharges.toLocaleString()}</span></div>
        <div class="sum-row"><span>Total Transactions</span><span>${day.transactions.length}</span></div>
      </div>
    </div>
    <div class="stitle">All Transactions ‚Äî ${day.date}</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Time</th><th>Type</th><th>Amount (KSh)</th><th>Charge (KSh)</th><th>Float Effect</th><th>Note</th><th></th></tr></thead>
        <tbody>${txnRows(day.transactions,false)}</tbody>
      </table>
    </div>`;
}

// ===================== RENDER HISTORY =====================
function renderHistory(){
  let closed=[...data.days].filter(d=>d.closed).sort((a,b)=>b.date.localeCompare(a.date));
  let el=document.getElementById('history-list');
  if(!closed.length){ el.innerHTML='<div class="empty"><div class="empty-icon">üìÖ</div>No closed days yet</div>'; return; }

  el.innerHTML=closed.map(day=>{
    let s=calcDayStats(day);
    let variance=(day.closeFloat+day.closeMpesa)-s.expectedTotal;
    return `<div class="history-day">
      <div class="history-day-header">
        <h3>üìÖ ${day.date}</h3>
        <span class="badge ${variance>=0?'badge-dep':'badge-wit'}">Variance: ${variance>=0?'+':''}KSh ${variance.toLocaleString()}</span>
      </div>
      <div class="day-stats">
        <div class="day-stat">Open Float: <strong>KSh ${day.openFloat.toLocaleString()}</strong></div>
        <div class="day-stat">Open E-Float: <strong>KSh ${day.openMpesa.toLocaleString()}</strong></div>
        <div class="day-stat">Close Float: <strong>KSh ${(day.closeFloat||0).toLocaleString()}</strong></div>
        <div class="day-stat">Close E-Float: <strong>KSh ${(day.closeMpesa||0).toLocaleString()}</strong></div>
        <div class="day-stat">Charges Earned: <strong style="color:var(--green)">KSh ${s.totalCharges.toLocaleString()}</strong></div>
        <div class="day-stat">Transactions: <strong>${day.transactions.length}</strong></div>
      </div>
    </div>`;
  }).join('');
}

// Init
renderToday();
</script>
</body>
</html>
