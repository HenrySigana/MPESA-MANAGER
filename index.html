
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M-Pesa Shop Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700;900&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f0faf5;
  --surface: #fff;
  --card: #fff;
  --green: #00a550;
  --green-dark: #007a3a;
  --green-light: #e6f7ef;
  --red: #e53e3e;
  --red-light: #fff5f5;
  --red-mid: #fca5a5;
  --amber: #d97706;
  --amber-light: #fffbeb;
  --blue: #2563eb;
  --blue-light: #eff6ff;
  --text: #1a2e22;
  --muted: #6b7280;
  --border: #d1fae5;
  --shadow: 0 4px 24px rgba(0,165,80,0.10);
  --radius: 16px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Nunito',sans-serif;min-height:100vh;}

header{background:linear-gradient(135deg,#00a550,#007a3a,#005a2a);padding:18px 28px;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(0,100,50,0.25);}
.hi{display:flex;align-items:center;justify-content:space-between;max-width:1100px;margin:0 auto;}
.brand{display:flex;align-items:center;gap:14px;}
.brand-logo{width:48px;height:48px;background:rgba(255,255,255,0.2);border:2px solid rgba(255,255,255,0.35);border-radius:12px;display:grid;place-items:center;font-size:22px;}
.brand h1{font-family:'Orbitron',sans-serif;font-size:1.15rem;color:#fff;letter-spacing:1px;}
.brand p{font-size:0.68rem;color:rgba(255,255,255,0.75);letter-spacing:2px;text-transform:uppercase;margin-top:2px;}
.htime .hdate{font-family:'Orbitron',sans-serif;font-size:0.82rem;color:#fff;text-align:right;}
.htime .htimeval{font-size:0.7rem;color:rgba(255,255,255,0.7);text-align:right;margin-top:2px;}

nav{background:#fff;border-bottom:2px solid var(--border);padding:10px 24px;display:flex;gap:6px;overflow-x:auto;}
nav button{background:none;border:none;color:var(--muted);padding:8px 18px;border-radius:30px;cursor:pointer;font-family:'Nunito',sans-serif;font-size:0.88rem;font-weight:700;white-space:nowrap;transition:all 0.2s;}
nav button:hover{background:var(--green-light);color:var(--green);}
nav button.active{background:var(--green);color:#fff;}

main{max-width:1100px;margin:0 auto;padding:22px 20px;}
.tab{display:none;}.tab.active{display:block;}

.stitle{font-family:'Orbitron',sans-serif;font-size:0.88rem;color:var(--green-dark);letter-spacing:1px;margin-bottom:16px;display:flex;align-items:center;gap:10px;}
.stitle::after{content:'';flex:1;height:2px;background:var(--border);}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:14px;margin-bottom:26px;}
.stat{background:#fff;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border:1px solid var(--border);position:relative;overflow:hidden;}
.stat::after{content:'';position:absolute;bottom:-18px;right:-18px;width:70px;height:70px;border-radius:50%;background:var(--green-light);opacity:0.5;}
.stat.sg{border-top:3px solid var(--green);}
.stat.sr{border-top:3px solid var(--red);}
.stat.sa{border-top:3px solid var(--amber);}
.stat.sb{border-top:3px solid var(--blue);}
.stat-label{font-size:0.7rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:7px;}
.stat-val{font-family:'Orbitron',sans-serif;font-size:1.45rem;font-weight:700;color:var(--text);}
.stat-val.pos{color:var(--green);}
.stat-val.neg{color:var(--red);}
.stat-sub{font-size:0.72rem;color:var(--muted);margin-top:4px;}

/* FORMS */
.setup-card{background:#fff;border-radius:var(--radius);padding:22px;box-shadow:var(--shadow);border:1px solid var(--border);margin-bottom:22px;}
.fg{display:flex;flex-direction:column;gap:6px;}
label{font-size:0.72rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);}
input,select{background:var(--bg);border:1.5px solid var(--border);border-radius:10px;color:var(--text);padding:10px 13px;font-family:'Nunito',sans-serif;font-size:0.93rem;font-weight:600;outline:none;transition:border 0.2s;width:100%;}
input:focus,select:focus{border-color:var(--green);background:#fff;}

/* TWO COLUMN FORM LAYOUT */
.form-2col{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;}
.form-3col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:14px;}
.form-4col{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:14px;margin-bottom:14px;}
@media(max-width:700px){.form-2col,.form-3col,.form-4col{grid-template-columns:1fr 1fr;}}
@media(max-width:480px){.form-2col,.form-3col,.form-4col{grid-template-columns:1fr;}}

/* DUAL PANEL */
.dual-panel{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:22px;}
@media(max-width:760px){.dual-panel{grid-template-columns:1fr;}}

/* DEPOSIT FORM */
.deposit-form{background:#fff;border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);border:2px solid var(--green);position:relative;overflow:hidden;}
.deposit-form::before{content:'üì• DEPOSIT';position:absolute;top:0;right:0;background:var(--green);color:#fff;font-size:0.68rem;font-weight:800;letter-spacing:1.5px;padding:4px 12px;border-radius:0 var(--radius) 0 10px;}
.deposit-form .form-title{font-family:'Orbitron',sans-serif;font-size:0.85rem;color:var(--green-dark);margin-bottom:14px;padding-top:4px;}

/* WITHDRAWAL FORM */
.withdraw-form{background:#fff;border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);border:2px solid var(--red);position:relative;overflow:hidden;}
.withdraw-form::before{content:'üì§ WITHDRAWAL';position:absolute;top:0;right:0;background:var(--red);color:#fff;font-size:0.68rem;font-weight:800;letter-spacing:1.5px;padding:4px 12px;border-radius:0 var(--radius) 0 10px;}
.withdraw-form .form-title{font-family:'Orbitron',sans-serif;font-size:0.85rem;color:var(--red);margin-bottom:14px;padding-top:4px;}
.withdraw-form input:focus,.withdraw-form select:focus{border-color:var(--red);}

/* DIVIDER LABEL */
.divider-label{background:var(--green-light);border:1px solid var(--border);border-radius:8px;padding:7px 12px;font-size:0.72rem;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--green-dark);margin:10px 0 8px;}

/* BUTTONS */
.btn{padding:10px 24px;border-radius:10px;border:none;cursor:pointer;font-family:'Nunito',sans-serif;font-size:0.93rem;font-weight:700;transition:all 0.2s;}
.btn-green{background:var(--green);color:#fff;}
.btn-green:hover{background:var(--green-dark);transform:translateY(-1px);}
.btn-red{background:var(--red);color:#fff;}
.btn-red:hover{background:#c53030;transform:translateY(-1px);}
.btn-outline{background:none;border:2px solid var(--green);color:var(--green);}
.btn-outline:hover{background:var(--green-light);}
.btn-amber{background:var(--amber);color:#fff;}
.btn-sm{padding:5px 12px;font-size:0.8rem;}
.btn-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px;}

/* TABLE */
.table-wrap{overflow-x:auto;border-radius:var(--radius);border:1.5px solid var(--border);box-shadow:var(--shadow);background:#fff;margin-bottom:22px;}
table{width:100%;border-collapse:collapse;}
thead{background:linear-gradient(90deg,var(--green),var(--green-dark));}
th{padding:12px 14px;text-align:left;font-size:0.75rem;letter-spacing:1px;color:#fff;text-transform:uppercase;font-weight:700;white-space:nowrap;}
td{padding:11px 14px;border-top:1px solid var(--border);font-size:0.86rem;font-weight:600;vertical-align:top;}
tr:hover td{background:var(--green-light);}
.badge{display:inline-block;padding:3px 11px;border-radius:20px;font-size:0.73rem;font-weight:700;}
.bdep{background:var(--green-light);color:var(--green);}
.bwit{background:var(--red-light);color:var(--red);}
.bother{background:var(--blue-light);color:var(--blue);}

/* PERSON CELL */
.pcell{line-height:1.5;}
.pcell .pname{font-weight:700;font-size:0.86rem;}
.pcell .pphone{font-size:0.76rem;color:var(--muted);}
.pcell .pid{font-size:0.72rem;color:var(--blue);}

/* CLOSE DAY */
.close-panel{background:#fffbeb;border:2px solid var(--amber);border-radius:var(--radius);padding:20px;margin-bottom:20px;}
.close-panel h3{font-family:'Orbitron',sans-serif;font-size:0.82rem;color:var(--amber);margin-bottom:14px;}

/* SUMMARY */
.summary-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:22px;}
@media(max-width:600px){.summary-row{grid-template-columns:1fr;}}
.summary-box{background:#fff;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border:1px solid var(--border);}
.summary-box h3{font-family:'Orbitron',sans-serif;font-size:0.78rem;color:var(--green-dark);margin-bottom:13px;}
.sum-row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px dashed var(--border);font-size:0.86rem;}
.sum-row:last-child{border:none;font-weight:800;font-size:0.95rem;}
.sum-row span:last-child{font-family:'Orbitron',sans-serif;font-size:0.88rem;}
.profit{color:var(--green);}
.loss{color:var(--red);}

/* HISTORY */
.history-day{background:#fff;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border:1px solid var(--border);margin-bottom:14px;}
.history-day-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.history-day-header h3{font-family:'Orbitron',sans-serif;font-size:0.82rem;color:var(--green-dark);}
.day-stats{display:flex;gap:14px;flex-wrap:wrap;}
.day-stat{font-size:0.8rem;color:var(--muted);}
.day-stat strong{color:var(--text);}

/* ALERTS */
.alert{border-radius:10px;padding:11px 15px;font-size:0.86rem;font-weight:600;margin-bottom:14px;}
.alert-green{background:var(--green-light);color:var(--green-dark);border:1px solid var(--green);}
.alert-amber{background:var(--amber-light);color:var(--amber);border:1px solid var(--amber);}
.alert-red{background:var(--red-light);color:var(--red);border:1px solid var(--red);}

/* DAY STATUS */
.day-status{display:inline-flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;font-size:0.78rem;font-weight:700;margin-bottom:16px;}
.day-open{background:var(--green-light);color:var(--green);}
.day-closed{background:var(--red-light);color:var(--red);}
.dot{width:8px;height:8px;border-radius:50%;background:currentColor;}

/* OTHER TXN FORM */
.other-form{background:#fff;border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);border:2px solid var(--blue);margin-bottom:22px;}
.other-form .form-title{font-family:'Orbitron',sans-serif;font-size:0.85rem;color:var(--blue);margin-bottom:14px;}

.empty{text-align:center;padding:36px;color:var(--muted);}
.empty-icon{font-size:2.8rem;opacity:0.35;margin-bottom:10px;}

#toast{position:fixed;bottom:22px;right:18px;background:var(--green);color:#fff;padding:12px 22px;border-radius:12px;font-family:'Nunito',sans-serif;font-weight:700;font-size:0.92rem;opacity:0;transform:translateY(14px);transition:all 0.3s;pointer-events:none;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.2);}
#toast.show{opacity:1;transform:translateY(0);}

/* CHARGE INFO BOX */
.charge-info{background:var(--amber-light);border:1px solid var(--amber);border-radius:8px;padding:8px 12px;font-size:0.8rem;color:var(--amber);font-weight:700;margin-top:6px;}
</style>
</head>
<body>

<header>
<div class="hi">
  <div class="brand">
    <div class="brand-logo">üì±</div>
    <div>
      <h1>M-PESA MANAGER</h1>
      <p>Daily Float & Cash Tracker</p>
    </div>
  </div>
  <div class="htime">
    <div class="hdate" id="hDate"></div>
    <div class="htimeval" id="hTime"></div>
  </div>
</div>
</header>

<nav>
  <button class="active" onclick="switchTab('today',this)">üìä Dashboard</button>
  <button onclick="switchTab('deposit',this)">üì• Deposits</button>
  <button onclick="switchTab('withdraw',this)">üì§ Withdrawals</button>
  <button onclick="switchTab('other',this)">üîÑ Other</button>
  <button onclick="switchTab('summary',this)">üìã Summary</button>
  <button onclick="switchTab('history',this)">üìÖ History</button>
</nav>

<main>

<!-- ===== DASHBOARD ===== -->
<div class="tab active" id="tab-today">
  <div id="no-day-panel">
    <div class="alert alert-amber">‚ö†Ô∏è No active session. Open today's business day to start recording.</div>
    <div class="setup-card">
      <div class="stitle">üåÖ Open Business Day</div>
      <div class="form-3col">
        <div class="fg"><label>Date</label><input type="date" id="open-date"></div>
        <div class="fg"><label>Opening Float ‚Äî Cash in Till (KSh)</label><input type="number" id="open-float" placeholder="e.g. 5000" min="0"></div>
        <div class="fg"><label>Opening M-Pesa E-Float (KSh)</label><input type="number" id="open-mpesa" placeholder="e.g. 10000" min="0"></div>
      </div>
      <button class="btn btn-green" onclick="openDay()">üåÖ Open Day</button>
    </div>
  </div>

  <div id="day-panel" style="display:none">
    <div id="day-status-badge"></div>
    <div class="stats-grid" id="live-stats"></div>

    <div id="close-day-section" style="display:none">
      <div class="close-panel">
        <h3>üåá CLOSE BUSINESS DAY</h3>
        <div class="form-2col">
          <div class="fg"><label>Closing Float ‚Äî Actual Cash in Till (KSh)</label><input type="number" id="close-float" placeholder="Count cash..." min="0"></div>
          <div class="fg"><label>Closing M-Pesa E-Float (KSh)</label><input type="number" id="close-mpesa" placeholder="Check M-Pesa balance..." min="0"></div>
        </div>
        <div class="btn-row">
          <button class="btn btn-amber" onclick="closeDay()">üåá Close & Save Day</button>
          <button class="btn btn-outline btn-sm" onclick="document.getElementById('close-day-section').style.display='none'">Cancel</button>
        </div>
      </div>
    </div>

    <div id="open-actions" class="btn-row" style="margin-bottom:20px">
      <button class="btn btn-green" onclick="switchTab('deposit',document.querySelectorAll('nav button')[1])">üì• Record Deposit</button>
      <button class="btn btn-red" onclick="switchTab('withdraw',document.querySelectorAll('nav button')[2])">üì§ Record Withdrawal</button>
      <button class="btn btn-red btn-sm" style="margin-left:auto" onclick="document.getElementById('close-day-section').style.display='block'">üåá Close Day</button>
    </div>

    <div class="stitle">Today's All Transactions</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Time</th><th>Type</th><th>Customer Name</th><th>Phone</th><th>ID No.</th><th>Amount (KSh)</th><th>Charge (KSh)</th><th>Sender / Receiver</th><th>Note</th><th></th></tr></thead>
        <tbody id="today-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== DEPOSITS TAB ===== -->
<div class="tab" id="tab-deposit">
  <div id="dep-no-day" class="alert alert-amber" style="display:none">‚ö†Ô∏è Please open a business day first.</div>
  <div id="dep-wrap">
    <div class="deposit-form" style="margin-bottom:22px">
      <div class="form-title">üì• Record Customer Deposit (Send Money)</div>

      <div class="divider-label">üë§ Customer Details (Who is Sending)</div>
      <div class="form-3col">
        <div class="fg"><label>Customer Full Name</label><input type="text" id="dep-cust-name" placeholder="e.g. John Kamau"></div>
        <div class="fg"><label>Customer Phone No.</label><input type="tel" id="dep-cust-phone" placeholder="e.g. 0712 345 678"></div>
        <div class="fg"><label>ID / Passport No. (optional)</label><input type="text" id="dep-cust-id" placeholder="e.g. 12345678"></div>
      </div>

      <div class="divider-label">üì• Receiver Details (Who Gets the Money)</div>
      <div class="form-3col">
        <div class="fg"><label>Receiver Full Name</label><input type="text" id="dep-recv-name" placeholder="e.g. Jane Wanjiru"></div>
        <div class="fg"><label>Receiver Phone No.</label><input type="tel" id="dep-recv-phone" placeholder="e.g. 0722 987 654"></div>
        <div class="fg"><label>Receiver ID (optional)</label><input type="text" id="dep-recv-id" placeholder="e.g. 87654321"></div>
      </div>

      <div class="divider-label">üí∞ Transaction Details</div>
      <div class="form-3col">
        <div class="fg"><label>Amount Deposited (KSh)</label><input type="number" id="dep-amount" placeholder="e.g. 2000" min="0"></div>
        <div class="fg"><label>M-Pesa Charge (KSh)</label><input type="number" id="dep-charge" value="0" min="0"><div class="charge-info" id="dep-charge-info" style="display:none"></div></div>
        <div class="fg"><label>Note / Reference</label><input type="text" id="dep-note" placeholder="Optional"></div>
      </div>

      <div class="btn-row">
        <button class="btn btn-green" onclick="recordDeposit()">‚úÖ Record Deposit</button>
        <button class="btn btn-outline" onclick="clearDepForm()">Clear</button>
      </div>
    </div>

    <div class="stitle">Today's Deposits</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Time</th><th>Customer (Sender)</th><th>Phone</th><th>ID No.</th><th>Receiver</th><th>Receiver Phone</th><th>Amount (KSh)</th><th>Charge (KSh)</th><th>Note</th><th></th></tr></thead>
        <tbody id="dep-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== WITHDRAWALS TAB ===== -->
<div class="tab" id="tab-withdraw">
  <div id="wit-no-day" class="alert alert-amber" style="display:none">‚ö†Ô∏è Please open a business day first.</div>
  <div id="wit-wrap">
    <div class="withdraw-form" style="margin-bottom:22px">
      <div class="form-title">üì§ Record Customer Withdrawal</div>

      <div class="divider-label" style="background:#fff5f5;border-color:var(--red-mid);color:var(--red)">üë§ Customer Details (Who is Withdrawing)</div>
      <div class="form-3col">
        <div class="fg"><label>Customer Full Name</label><input type="text" id="wit-cust-name" placeholder="e.g. Mary Otieno"></div>
        <div class="fg"><label>Customer Phone No.</label><input type="tel" id="wit-cust-phone" placeholder="e.g. 0733 111 222"></div>
        <div class="fg"><label>ID / Passport No.</label><input type="text" id="wit-cust-id" placeholder="e.g. 23456789"></div>
      </div>

      <div class="divider-label" style="background:#fff5f5;border-color:var(--red-mid);color:var(--red)">üíµ Withdrawal Details</div>
      <div class="form-3col">
        <div class="fg"><label>Amount Withdrawn (KSh)</label><input type="number" id="wit-amount" placeholder="e.g. 5000" min="0" oninput="autoCharge()"></div>
        <div class="fg"><label>M-Pesa Charge (KSh) <span style="color:var(--green);font-size:0.68rem">auto-calc</span></label><input type="number" id="wit-charge" placeholder="0" min="0"><div class="charge-info" id="wit-charge-info" style="display:none"></div></div>
        <div class="fg"><label>Note / Reference</label><input type="text" id="wit-note" placeholder="Optional"></div>
      </div>

      <div class="btn-row">
        <button class="btn btn-red" onclick="recordWithdrawal()">‚úÖ Record Withdrawal</button>
        <button class="btn btn-outline" onclick="clearWitForm()">Clear</button>
      </div>
    </div>

    <div class="stitle">Today's Withdrawals</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Time</th><th>Customer Name</th><th>Phone</th><th>ID No.</th><th>Amount Withdrawn (KSh)</th><th>Charge Earned (KSh)</th><th>Note</th><th></th></tr></thead>
        <tbody id="wit-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== OTHER TRANSACTIONS TAB ===== -->
<div class="tab" id="tab-other">
  <div id="oth-no-day" class="alert alert-amber" style="display:none">‚ö†Ô∏è Please open a business day first.</div>
  <div id="oth-wrap">
    <div class="other-form">
      <div class="form-title">üîÑ Other Transactions (Float Management)</div>
      <div class="form-4col">
        <div class="fg">
          <label>Type</label>
          <select id="oth-type">
            <option value="buy_float">üîÑ Buy E-Float (Top Up)</option>
            <option value="sell_float">üíµ Sell Float (Convert to Cash)</option>
            <option value="till_deposit">üè¶ Till Deposit (Bank ‚Üí M-Pesa)</option>
            <option value="till_withdraw">üèß Till Withdrawal (M-Pesa ‚Üí Bank)</option>
          </select>
        </div>
        <div class="fg"><label>Amount (KSh)</label><input type="number" id="oth-amount" placeholder="0" min="0"></div>
        <div class="fg"><label>Person / Agent Name</label><input type="text" id="oth-name" placeholder="e.g. Safaricom Agent"></div>
        <div class="fg"><label>Note</label><input type="text" id="oth-note" placeholder="Optional"></div>
      </div>
      <div class="btn-row">
        <button class="btn btn-green" onclick="recordOther()">‚úÖ Record</button>
        <button class="btn btn-outline" onclick="clearOthForm()">Clear</button>
      </div>
    </div>

    <div class="stitle">Today's Other Transactions</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Time</th><th>Type</th><th>Person / Agent</th><th>Amount (KSh)</th><th>Note</th><th></th></tr></thead>
        <tbody id="oth-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== SUMMARY TAB ===== -->
<div class="tab" id="tab-summary">
  <div id="summary-content"></div>
</div>

<!-- ===== HISTORY TAB ===== -->
<div class="tab" id="tab-history">
  <div class="stitle">üìÖ Past Business Days</div>
  <div id="history-list"></div>
</div>

</main>
<div id="toast"></div>

<script>
// ===================== DATA =====================
let data = JSON.parse(localStorage.getItem('mpesa_v2') || '{"days":[],"activeDay":null}');
function save(){ localStorage.setItem('mpesa_v2', JSON.stringify(data)); }

// ===================== CLOCK =====================
function pad(n){ return String(n).padStart(2,'0'); }
function nowStr(){ let n=new Date(); return `${pad(n.getHours())}:${pad(n.getMinutes())}`; }
function todayStr(){ let d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function tick(){
  let n=new Date();
  document.getElementById('hDate').textContent=n.toLocaleDateString('en-KE',{weekday:'short',day:'numeric',month:'long',year:'numeric'});
  document.getElementById('hTime').textContent=n.toLocaleTimeString('en-KE');
}
setInterval(tick,1000); tick();
document.getElementById('open-date').value=todayStr();

// ===================== TOAST =====================
function toast(msg,type='green'){
  let t=document.getElementById('toast');
  t.textContent=msg;
  t.style.background=type==='red'?'#e53e3e':type==='amber'?'#d97706':'#00a550';
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2800);
}

// ===================== TABS =====================
function switchTab(t,btn){
  document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(e=>e.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
  if(btn) btn.classList.add('active');
  if(t==='today')    renderDashboard();
  if(t==='deposit')  renderDepTab();
  if(t==='withdraw') renderWitTab();
  if(t==='other')    renderOthTab();
  if(t==='summary')  renderSummary();
  if(t==='history')  renderHistory();
}

// ===================== WITHDRAWAL CHARGE TARIFF =====================
const TARIFF=[[1,49,0],[50,100,11],[101,500,29],[501,2500,29],[2501,3500,52],[3501,5000,69],[5001,7500,87],[7501,10000,115],[10001,15000,167],[15001,20000,185],[20001,25000,197],[25001,30000,208],[30001,35000,220],[35001,40000,233],[40001,45000,245],[45001,50000,258],[50001,70000,290],[70001,100000,350],[100001,150000,513]];
function getCharge(amt){ for(let [lo,hi,fee] of TARIFF){ if(amt>=lo&&amt<=hi) return fee; } return 0; }

function autoCharge(){
  let amt=parseFloat(document.getElementById('wit-amount').value)||0;
  let ch=getCharge(amt);
  document.getElementById('wit-charge').value=ch;
  let info=document.getElementById('wit-charge-info');
  if(amt>0){ info.style.display='block'; info.textContent=`Safaricom charge for KSh ${amt.toLocaleString()}: KSh ${ch}`; }
  else info.style.display='none';
}

// ===================== OPEN / CLOSE DAY =====================
function openDay(){
  let date=document.getElementById('open-date').value;
  let openFloat=parseFloat(document.getElementById('open-float').value)||0;
  let openMpesa=parseFloat(document.getElementById('open-mpesa').value)||0;
  if(!date){ toast('Select a date','amber'); return; }
  let newDay={ id:Date.now(), date, openFloat, openMpesa, closeFloat:null, closeMpesa:null, closed:false, deposits:[], withdrawals:[], others:[] };
  data.days.push(newDay);
  data.activeDay=newDay.id;
  save(); toast('üåÖ Day opened!'); renderDashboard();
}

function closeDay(){
  let cf=parseFloat(document.getElementById('close-float').value);
  let cm=parseFloat(document.getElementById('close-mpesa').value);
  if(isNaN(cf)||isNaN(cm)){ toast('Enter both closing balances','amber'); return; }
  let day=getActiveDay(); if(!day) return;
  day.closeFloat=cf; day.closeMpesa=cm; day.closed=true; data.activeDay=null;
  save(); toast('üåá Day closed!'); renderDashboard();
}

function getActiveDay(){
  if(!data.activeDay) return null;
  return data.days.find(d=>d.id===data.activeDay);
}

// ===================== RECORD TRANSACTIONS =====================
function recordDeposit(){
  let day=getActiveDay(); if(!day){ toast('Open a day first','amber'); return; }
  let custName=document.getElementById('dep-cust-name').value.trim();
  let custPhone=document.getElementById('dep-cust-phone').value.trim();
  let custId=document.getElementById('dep-cust-id').value.trim();
  let recvName=document.getElementById('dep-recv-name').value.trim();
  let recvPhone=document.getElementById('dep-recv-phone').value.trim();
  let recvId=document.getElementById('dep-recv-id').value.trim();
  let amount=parseFloat(document.getElementById('dep-amount').value)||0;
  let charge=parseFloat(document.getElementById('dep-charge').value)||0;
  let note=document.getElementById('dep-note').value.trim();
  if(!amount){ toast('Enter deposit amount','amber'); return; }
  if(!custName){ toast('Enter customer name','amber'); return; }
  day.deposits.push({ id:Date.now(), time:nowStr(), custName, custPhone, custId, recvName, recvPhone, recvId, amount, charge, note });
  save(); clearDepForm(); toast('‚úÖ Deposit recorded!'); renderDepTab(); renderDashboard();
}

function recordWithdrawal(){
  let day=getActiveDay(); if(!day){ toast('Open a day first','amber'); return; }
  let custName=document.getElementById('wit-cust-name').value.trim();
  let custPhone=document.getElementById('wit-cust-phone').value.trim();
  let custId=document.getElementById('wit-cust-id').value.trim();
  let amount=parseFloat(document.getElementById('wit-amount').value)||0;
  let charge=parseFloat(document.getElementById('wit-charge').value)||0;
  let note=document.getElementById('wit-note').value.trim();
  if(!amount){ toast('Enter withdrawal amount','amber'); return; }
  if(!custName){ toast('Enter customer name','amber'); return; }
  day.withdrawals.push({ id:Date.now(), time:nowStr(), custName, custPhone, custId, amount, charge, note });
  save(); clearWitForm(); toast('‚úÖ Withdrawal recorded!'); renderWitTab(); renderDashboard();
}

function recordOther(){
  let day=getActiveDay(); if(!day){ toast('Open a day first','amber'); return; }
  let type=document.getElementById('oth-type').value;
  let amount=parseFloat(document.getElementById('oth-amount').value)||0;
  let name=document.getElementById('oth-name').value.trim();
  let note=document.getElementById('oth-note').value.trim();
  if(!amount){ toast('Enter amount','amber'); return; }
  day.others.push({ id:Date.now(), time:nowStr(), type, amount, name, note });
  save(); clearOthForm(); toast('‚úÖ Recorded!'); renderOthTab(); renderDashboard();
}

// ===================== CLEAR FORMS =====================
function clearDepForm(){ ['dep-cust-name','dep-cust-phone','dep-cust-id','dep-recv-name','dep-recv-phone','dep-recv-id','dep-amount','dep-note'].forEach(id=>document.getElementById(id).value=''); document.getElementById('dep-charge').value=0; }
function clearWitForm(){ ['wit-cust-name','wit-cust-phone','wit-cust-id','wit-amount','wit-note'].forEach(id=>document.getElementById(id).value=''); document.getElementById('wit-charge').value=0; document.getElementById('wit-charge-info').style.display='none'; }
function clearOthForm(){ ['oth-amount','oth-name','oth-note'].forEach(id=>document.getElementById(id).value=''); }

// ===================== DELETE =====================
function delDeposit(id){ let day=getActiveDay(); if(!day||day.closed){ toast('Cannot delete from closed day','red'); return; } if(!confirm('Delete this deposit?')) return; day.deposits=day.deposits.filter(x=>x.id!=id); save(); renderDepTab(); renderDashboard(); toast('üóë Deleted','amber'); }
function delWithdrawal(id){ let day=getActiveDay(); if(!day||day.closed){ toast('Cannot delete from closed day','red'); return; } if(!confirm('Delete this withdrawal?')) return; day.withdrawals=day.withdrawals.filter(x=>x.id!=id); save(); renderWitTab(); renderDashboard(); toast('üóë Deleted','amber'); }
function delOther(id){ let day=getActiveDay(); if(!day||day.closed){ toast('Cannot delete','red'); return; } if(!confirm('Delete?')) return; day.others=day.others.filter(x=>x.id!=id); save(); renderOthTab(); renderDashboard(); toast('üóë Deleted','amber'); }

// ===================== CALC STATS =====================
function calcStats(day){
  let deposits=day.deposits||[], withdrawals=day.withdrawals||[], others=day.others||[];
  let totalDep=deposits.reduce((a,b)=>a+b.amount,0);
  let totalWit=withdrawals.reduce((a,b)=>a+b.amount,0);
  let totalCharges=withdrawals.reduce((a,b)=>a+b.charge,0);
  let floatCash=day.openFloat;
  let eMpesa=day.openMpesa;
  // deposits: cash in, e-float out
  floatCash+=totalDep; eMpesa-=totalDep;
  // withdrawals: cash out, e-float in + charge cash
  floatCash-=totalWit; eMpesa+=totalWit; floatCash+=totalCharges;
  // others
  others.forEach(o=>{
    if(o.type==='buy_float'){ floatCash-=o.amount; eMpesa+=o.amount; }
    if(o.type==='sell_float'){ floatCash+=o.amount; eMpesa-=o.amount; }
    if(o.type==='till_deposit'){ eMpesa+=o.amount; }
    if(o.type==='till_withdraw'){ eMpesa-=o.amount; }
  });
  return { floatCash, eMpesa, totalFloat:floatCash+eMpesa, totalDep, totalWit, totalCharges, depCount:deposits.length, witCount:withdrawals.length };
}

// ===================== RENDER DASHBOARD =====================
function renderDashboard(){
  let day=getActiveDay();
  let nop=document.getElementById('no-day-panel');
  let dp=document.getElementById('day-panel');
  if(!day){
    nop.style.display='block'; dp.style.display='none';
    let closedToday=data.days.find(d=>d.date===todayStr()&&d.closed);
    if(closedToday) nop.innerHTML=`<div class="alert alert-green">‚úÖ Today's business day is closed. <button class="btn btn-outline btn-sm" onclick="location.reload()">Start New Day</button></div>`;
    return;
  }
  nop.style.display='none'; dp.style.display='block';
  document.getElementById('day-status-badge').innerHTML=`<div class="day-status ${day.closed?'day-closed':'day-open'}"><div class="dot"></div>${day.closed?'Day Closed':'Day Open'} ‚Äî ${day.date}</div>`;
  let s=calcStats(day);
  document.getElementById('live-stats').innerHTML=`
    <div class="stat sg"><div class="stat-label">Cash Float (Till)</div><div class="stat-val pos">KSh ${s.floatCash.toLocaleString()}</div><div class="stat-sub">Opened: KSh ${day.openFloat.toLocaleString()}</div></div>
    <div class="stat sb"><div class="stat-label">M-Pesa E-Float</div><div class="stat-val" style="color:var(--blue)">KSh ${s.eMpesa.toLocaleString()}</div><div class="stat-sub">Opened: KSh ${day.openMpesa.toLocaleString()}</div></div>
    <div class="stat sg"><div class="stat-label">Deposits Today</div><div class="stat-val pos">KSh ${s.totalDep.toLocaleString()}</div><div class="stat-sub">${s.depCount} transactions</div></div>
    <div class="stat sr"><div class="stat-label">Withdrawals Today</div><div class="stat-val neg">KSh ${s.totalWit.toLocaleString()}</div><div class="stat-sub">${s.witCount} transactions</div></div>
    <div class="stat sa"><div class="stat-label">Charges Earned</div><div class="stat-val pos">KSh ${s.totalCharges.toLocaleString()}</div><div class="stat-sub">From withdrawals</div></div>
    <div class="stat"><div class="stat-label">Total Float Value</div><div class="stat-val">KSh ${s.totalFloat.toLocaleString()}</div><div class="stat-sub">Cash + E-Float</div></div>`;

  document.getElementById('open-actions').style.display=day.closed?'none':'flex';

  // All txns combined
  let allTxns=[
    ...(day.deposits||[]).map(d=>({...d,_type:'deposit'})),
    ...(day.withdrawals||[]).map(w=>({...w,_type:'withdraw'})),
    ...(day.others||[]).map(o=>({...o,_type:'other'}))
  ].sort((a,b)=>b.id-a.id);

  let tbody=document.getElementById('today-tbody');
  if(!allTxns.length){ tbody.innerHTML='<tr><td colspan="10"><div class="empty"><div class="empty-icon">üì≠</div>No transactions yet today</div></td></tr>'; return; }
  tbody.innerHTML=allTxns.map(t=>{
    if(t._type==='deposit') return `<tr>
      <td>${t.time}</td><td><span class="badge bdep">üì• Deposit</span></td>
      <td><div class="pcell"><div class="pname">${t.custName||'‚Äî'}</div></div></td>
      <td><div class="pcell"><div class="pphone">${t.custPhone||'‚Äî'}</div></div></td>
      <td style="color:var(--blue)">${t.custId||'‚Äî'}</td>
      <td style="color:var(--green);font-weight:800">KSh ${t.amount.toLocaleString()}</td>
      <td>${t.charge?`KSh ${t.charge}`:'‚Äî'}</td>
      <td><div class="pcell"><div class="pname">${t.recvName||'‚Äî'}</div><div class="pphone">${t.recvPhone||''}</div></div></td>
      <td style="color:var(--muted);font-size:0.8rem">${t.note||'‚Äî'}</td>
      <td>${!day.closed?`<button class="btn btn-sm" style="background:#fee2e2;color:var(--red);border:none;cursor:pointer;border-radius:6px" onclick="delDeposit('${t.id}')">üóë</button>`:'‚Äî'}</td>
    </tr>`;
    if(t._type==='withdraw') return `<tr>
      <td>${t.time}</td><td><span class="badge bwit">üì§ Withdrawal</span></td>
      <td><div class="pcell"><div class="pname">${t.custName||'‚Äî'}</div></div></td>
      <td><div class="pcell"><div class="pphone">${t.custPhone||'‚Äî'}</div></div></td>
      <td style="color:var(--blue)">${t.custId||'‚Äî'}</td>
      <td style="color:var(--red);font-weight:800">KSh ${t.amount.toLocaleString()}</td>
      <td style="color:var(--amber);font-weight:700">${t.charge?`KSh ${t.charge}`:'‚Äî'}</td>
      <td>‚Äî</td>
      <td style="color:var(--muted);font-size:0.8rem">${t.note||'‚Äî'}</td>
      <td>${!day.closed?`<button class="btn btn-sm" style="background:#fee2e2;color:var(--red);border:none;cursor:pointer;border-radius:6px" onclick="delWithdrawal('${t.id}')">üóë</button>`:'‚Äî'}</td>
    </tr>`;
    return `<tr>
      <td>${t.time}</td><td><span class="badge bother">${othLabel(t.type)}</span></td>
      <td colspan="2">${t.name||'‚Äî'}</td><td>‚Äî</td>
      <td style="font-weight:700">KSh ${t.amount.toLocaleString()}</td>
      <td>‚Äî</td><td>‚Äî</td>
      <td style="color:var(--muted);font-size:0.8rem">${t.note||'‚Äî'}</td>
      <td>${!day.closed?`<button class="btn btn-sm" style="background:#fee2e2;color:var(--red);border:none;cursor:pointer;border-radius:6px" onclick="delOther('${t.id}')">üóë</button>`:'‚Äî'}</td>
    </tr>`;
  }).join('');
}

function othLabel(type){ const m={'buy_float':'üîÑ Buy Float','sell_float':'üíµ Sell Float','till_deposit':'üè¶ Till Dep','till_withdraw':'üèß Till With'}; return m[type]||type; }

// ===================== RENDER DEP TAB =====================
function renderDepTab(){
  let day=getActiveDay();
  document.getElementById('dep-no-day').style.display=!day?'block':'none';
  document.getElementById('dep-wrap').style.opacity=!day?'0.5':'1';
  document.getElementById('dep-wrap').style.pointerEvents=!day?'none':'auto';
  let deposits=(day||{deposits:[]}).deposits||[];
  let tbody=document.getElementById('dep-tbody');
  if(!deposits.length){ tbody.innerHTML='<tr><td colspan="10"><div class="empty"><div class="empty-icon">üì•</div>No deposits recorded today</div></td></tr>'; return; }
  tbody.innerHTML=[...deposits].reverse().map(d=>`
    <tr>
      <td>${d.time}</td>
      <td><div class="pcell"><div class="pname">${d.custName||'‚Äî'}</div></div></td>
      <td><div class="pcell"><div class="pphone">${d.custPhone||'‚Äî'}</div></div></td>
      <td style="color:var(--blue)">${d.custId||'‚Äî'}</td>
      <td><div class="pcell"><div class="pname">${d.recvName||'‚Äî'}</div></div></td>
      <td><div class="pcell"><div class="pphone">${d.recvPhone||'‚Äî'}</div></div></td>
      <td style="color:var(--green);font-weight:800">KSh ${d.amount.toLocaleString()}</td>
      <td>${d.charge?`KSh ${d.charge}`:'‚Äî'}</td>
      <td style="color:var(--muted);font-size:0.8rem">${d.note||'‚Äî'}</td>
      <td>${day&&!day.closed?`<button class="btn btn-sm" style="background:#fee2e2;color:var(--red);border:none;cursor:pointer;border-radius:6px" onclick="delDeposit('${d.id}')">üóë</button>`:'‚Äî'}</td>
    </tr>`).join('');
}

// ===================== RENDER WIT TAB =====================
function renderWitTab(){
  let day=getActiveDay();
  document.getElementById('wit-no-day').style.display=!day?'block':'none';
  document.getElementById('wit-wrap').style.opacity=!day?'0.5':'1';
  document.getElementById('wit-wrap').style.pointerEvents=!day?'none':'auto';
  let withdrawals=(day||{withdrawals:[]}).withdrawals||[];
  let tbody=document.getElementById('wit-tbody');
  if(!withdrawals.length){ tbody.innerHTML='<tr><td colspan="8"><div class="empty"><div class="empty-icon">üì§</div>No withdrawals recorded today</div></td></tr>'; return; }
  tbody.innerHTML=[...withdrawals].reverse().map(w=>`
    <tr>
      <td>${w.time}</td>
      <td><div class="pcell"><div class="pname">${w.custName||'‚Äî'}</div></div></td>
      <td><div class="pcell"><div class="pphone">${w.custPhone||'‚Äî'}</div></div></td>
      <td style="color:var(--blue)">${w.custId||'‚Äî'}</td>
      <td style="color:var(--red);font-weight:800">KSh ${w.amount.toLocaleString()}</td>
      <td style="color:var(--amber);font-weight:700">KSh ${(w.charge||0).toLocaleString()}</td>
      <td style="color:var(--muted);font-size:0.8rem">${w.note||'‚Äî'}</td>
      <td>${day&&!day.closed?`<button class="btn btn-sm" style="background:#fee2e2;color:var(--red);border:none;cursor:pointer;border-radius:6px" onclick="delWithdrawal('${w.id}')">üóë</button>`:'‚Äî'}</td>
    </tr>`).join('');
}

// ===================== RENDER OTH TAB =====================
function renderOthTab(){
  let day=getActiveDay();
  document.getElementById('oth-no-day').style.display=!day?'block':'none';
  document.getElementById('oth-wrap').style.opacity=!day?'0.5':'1';
  document.getElementById('oth-wrap').style.pointerEvents=!day?'none':'auto';
  let others=(day||{others:[]}).others||[];
  let tbody=document.getElementById('oth-tbody');
  if(!others.length){ tbody.innerHTML='<tr><td colspan="6"><div class="empty"><div class="empty-icon">üîÑ</div>No other transactions today</div></td></tr>'; return; }
  tbody.innerHTML=[...others].reverse().map(o=>`
    <tr>
      <td>${o.time}</td>
      <td><span class="badge bother">${othLabel(o.type)}</span></td>
      <td>${o.name||'‚Äî'}</td>
      <td style="font-weight:700">KSh ${o.amount.toLocaleString()}</td>
      <td style="color:var(--muted);font-size:0.8rem">${o.note||'‚Äî'}</td>
      <td>${day&&!day.closed?`<button class="btn btn-sm" style="background:#fee2e2;color:var(--red);border:none;cursor:pointer;border-radius:6px" onclick="delOther('${o.id}')">üóë</button>`:'‚Äî'}</td>
    </tr>`).join('');
}

// ===================== RENDER SUMMARY =====================
function renderSummary(){
  let day=getActiveDay();
  if(!day){ let closed=[...data.days].filter(d=>d.closed).sort((a,b)=>b.date.localeCompare(a.date)); day=closed[0]; }
  if(!day){ document.getElementById('summary-content').innerHTML='<div class="empty"><div class="empty-icon">üìã</div>No day data yet.</div>'; return; }
  let s=calcStats(day);
  let variance=day.closed?(day.closeFloat+day.closeMpesa)-(s.floatCash+s.eMpesa):null;
  document.getElementById('summary-content').innerHTML=`
    <div class="day-status ${day.closed?'day-closed':'day-open'}"><div class="dot"></div>${day.closed?'Closed':'Open'} ‚Äî ${day.date}</div>
    <div class="summary-row">
      <div class="summary-box">
        <h3>üí∞ FLOAT POSITION</h3>
        <div class="sum-row"><span>Opening Cash Float</span><span>KSh ${day.openFloat.toLocaleString()}</span></div>
        <div class="sum-row"><span>Opening M-Pesa E-Float</span><span>KSh ${day.openMpesa.toLocaleString()}</span></div>
        <div class="sum-row"><span>Current Cash Float</span><span class="profit">KSh ${s.floatCash.toLocaleString()}</span></div>
        <div class="sum-row"><span>Current M-Pesa E-Float</span><span style="color:var(--blue)">KSh ${s.eMpesa.toLocaleString()}</span></div>
        ${day.closed?`<div class="sum-row"><span>Closing Float (Actual)</span><span>KSh ${(day.closeFloat||0).toLocaleString()}</span></div>
        <div class="sum-row"><span>Closing E-Float (Actual)</span><span>KSh ${(day.closeMpesa||0).toLocaleString()}</span></div>
        <div class="sum-row"><span>Variance</span><span class="${variance>=0?'profit':'loss'}">${variance>=0?'+':''}KSh ${variance.toLocaleString()}</span></div>`:''}
        <div class="sum-row"><span>Total Float Value</span><span>KSh ${s.totalFloat.toLocaleString()}</span></div>
      </div>
      <div class="summary-box">
        <h3>üìä TRANSACTIONS SUMMARY</h3>
        <div class="sum-row"><span>Total Deposited</span><span class="profit">KSh ${s.totalDep.toLocaleString()}</span></div>
        <div class="sum-row"><span>No. of Deposits</span><span>${s.depCount}</span></div>
        <div class="sum-row"><span>Total Withdrawn</span><span class="loss">KSh ${s.totalWit.toLocaleString()}</span></div>
        <div class="sum-row"><span>No. of Withdrawals</span><span>${s.witCount}</span></div>
        <div class="sum-row"><span>Charges Earned</span><span class="profit">KSh ${s.totalCharges.toLocaleString()}</span></div>
        <div class="sum-row"><span>Total Transactions</span><span>${s.depCount+s.witCount+(day.others||[]).length}</span></div>
      </div>
    </div>
    <div class="stitle">üì• All Deposits</div>
    <div class="table-wrap" style="margin-bottom:20px">
      <table>
        <thead><tr><th>Time</th><th>Customer Name</th><th>Phone</th><th>ID No.</th><th>Receiver</th><th>Recv. Phone</th><th>Amount (KSh)</th><th>Charge</th><th>Note</th></tr></thead>
        <tbody>${(day.deposits||[]).length?[...(day.deposits||[])].reverse().map(d=>`<tr>
          <td>${d.time}</td><td><b>${d.custName||'‚Äî'}</b></td><td>${d.custPhone||'‚Äî'}</td><td style="color:var(--blue)">${d.custId||'‚Äî'}</td>
          <td>${d.recvName||'‚Äî'}</td><td>${d.recvPhone||'‚Äî'}</td>
          <td style="color:var(--green);font-weight:800">KSh ${d.amount.toLocaleString()}</td>
          <td>${d.charge?`KSh ${d.charge}`:'‚Äî'}</td><td style="color:var(--muted)">${d.note||'‚Äî'}</td>
        </tr>`).join(''):'<tr><td colspan="9"><div class="empty" style="padding:20px">No deposits</div></td></tr>'}</tbody>
      </table>
    </div>
    <div class="stitle">üì§ All Withdrawals</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Time</th><th>Customer Name</th><th>Phone</th><th>ID No.</th><th>Amount Withdrawn (KSh)</th><th>Charge Earned (KSh)</th><th>Note</th></tr></thead>
        <tbody>${(day.withdrawals||[]).length?[...(day.withdrawals||[])].reverse().map(w=>`<tr>
          <td>${w.time}</td><td><b>${w.custName||'‚Äî'}</b></td><td>${w.custPhone||'‚Äî'}</td>
          <td style="color:var(--blue)">${w.custId||'‚Äî'}</td>
          <td style="color:var(--red);font-weight:800">KSh ${w.amount.toLocaleString()}</td>
          <td style="color:var(--amber);font-weight:700">KSh ${(w.charge||0).toLocaleString()}</td>
          <td style="color:var(--muted)">${w.note||'‚Äî'}</td>
        </tr>`).join(''):'<tr><td colspan="7"><div class="empty" style="padding:20px">No withdrawals</div></td></tr>'}</tbody>
      </table>
    </div>`;
}

// ===================== RENDER HISTORY =====================
function renderHistory(){
  let closed=[...data.days].filter(d=>d.closed).sort((a,b)=>b.date.localeCompare(a.date));
  let el=document.getElementById('history-list');
  if(!closed.length){ el.innerHTML='<div class="empty"><div class="empty-icon">üìÖ</div>No closed days yet</div>'; return; }
  el.innerHTML=closed.map(day=>{
    let s=calcStats(day);
    let variance=(day.closeFloat+day.closeMpesa)-s.totalFloat;
    return `<div class="history-day">
      <div class="history-day-header">
        <h3>üìÖ ${day.date}</h3>
        <span class="badge ${variance>=0?'bdep':'bwit'}">Variance: ${variance>=0?'+':''}KSh ${variance.toLocaleString()}</span>
      </div>
      <div class="day-stats">
        <div class="day-stat">Open Float: <strong>KSh ${day.openFloat.toLocaleString()}</strong></div>
        <div class="day-stat">Open E-Float: <strong>KSh ${day.openMpesa.toLocaleString()}</strong></div>
        <div class="day-stat">Close Float: <strong>KSh ${(day.closeFloat||0).toLocaleString()}</strong></div>
        <div class="day-stat">Close E-Float: <strong>KSh ${(day.closeMpesa||0).toLocaleString()}</strong></div>
        <div class="day-stat">Deposits: <strong style="color:var(--green)">${(day.deposits||[]).length} | KSh ${s.totalDep.toLocaleString()}</strong></div>
        <div class="day-stat">Withdrawals: <strong style="color:var(--red)">${(day.withdrawals||[]).length} | KSh ${s.totalWit.toLocaleString()}</strong></div>
        <div class="day-stat">Charges Earned: <strong style="color:var(--amber)">KSh ${s.totalCharges.toLocaleString()}</strong></div>
      </div>
    </div>`;
  }).join('');
}

// Init
renderDashboard();
</script>
</body>
</html>
